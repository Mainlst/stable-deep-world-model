# Copilot Instructions

- **Scope & layout**: Active code lives in `src_vta/` (VTA world model); `src/` is placeholder. Key files: `config.py`, `models/{vta.py,rssm.py,components.py}`, `scripts/train.py` (unified trainer), `scripts/train_envs/{balls.py,maze.py}`, `utils.py`, `data/` (generation/loaders).
- **Entrypoints**: Bouncing Balls `python -m src_vta.scripts.train_balls --config configs/bouncing_balls_3070.json`; 3D Maze `python -m src_vta.scripts.train_maze --config <maze.json>`; visualize `python -m src_vta.scripts.visualize <ckpt> --config <cfg> --idx 0 --num_samples 10`. Shell helpers in `scripts/train.sh` and `scripts/visualize.sh`.
- **Configs**: JSON fed to `load_config`; unknown keys are ignored, `_dir` keys become `Path`. `env_type` controls adapter choice (`bouncing_balls` vs `3d_maze`), loss (`bce` vs `mse`), action size (0 vs 3), and quantization (`obs_bit=None` vs 5). `beta_anneal/min_beta/max_beta` drive the boundary Gumbel temperature; set `beta_anneal=0` to keep it fixed. `seg_len/seg_num` bound segment lengths/counts in the RSSM prior regularizer.
- **Training loop** (`scripts/train.py`): Builds `VTA` then defers env specifics to an `EnvironmentAdapter`. Sets seeds, W&B run (`project=stable-deep-world-model`, `dir=work_dir`), TensorBoard writer at `<work_dir>/<exp_name>/logs`, checkpoints under `<work_dir>/<exp_name>/` (`model_best.pt` plus optional `ckpt_<step>.pt`). Uses AMP+GradScaler when allowed; gradients clipped if `grad_clip>0`. Progress and logging intervals come from the adapter.
- **Adapters pattern** (`scripts/train_envs`): Add envs by implementing `EnvironmentAdapter` + `TrainBatchProvider` and registering in `ADAPTERS`. Adapter hooks: `configure_args`, `build_context` (provides train provider, eval tensors, action size, AMP flag, intervals), `process_batch`, `log_metrics`, `on_best_model` (usually calls `visualize_results`).
- **Bouncing Balls data** (`train_envs/balls.py`): Uses on-the-fly generation via `data.bouncing_balls.generate_vta_dataset`. `BouncingBallsProvider` regenerates a chunk every `refresh_steps` to avoid overfitting/memory blowup; keep `seq_len = init_size + seq_size + 5`. Actions are zeroed (`action_size=0`); loss is BCE; AMP disabled here. Default config `configs/bouncing_balls_3070.json` sets `work_dir=experiments5_test`, `max_iters=50k`, `epoch_data_size=24000`.
- **3D Maze data** (`train_envs/maze.py`): Expects `3d_maze_default/{train,test}/*.npz` containing `video` and `actions`; generate via `python -m src_vta.data.generate_npz`. Loader lazily resizes frames to 32x32 and one-hot encodes 3 actions. Loss is MSE with `obs_bit=5`; actions are required (`action_size=3`); AMP allowed when CUDA. Missing npz files cause an early exit.
- **Model contract** (`models/{vta,rssm}.py`): `VTA.forward(obs, act, seq_size, init_size, obs_std, loss_type)` expects `obs` shape `[B,T,C,H,W]` and `act` shape `[B,T,A]`. Hierarchical RSSM performs boundary detection via straight-through Gumbel (`mask_beta`), enforces `seg_len/seg_num`, and returns reconstruction, mask, KL terms, entropies, and `train_loss`. Use `loss_type="bce"` for pixel-wise BCE, else Gaussian NLL with `obs_std`.
- **Pre/post-processing** (`utils.py`): `preprocess(bits)` quantizes inputs; pass `obs_bit=None` for raw floats (Bouncing Balls) or 5 for Maze. `visualize_results` expects a DataLoader batch and saves `vis_seq_<idx>.png` under `work_dir`; it highlights ground-truth collisions (Bouncing Balls) and predicted boundaries.
- **Visualization usage**: The visualize script auto-selects dataset generator based on `config.env_type`; ensure the checkpoint path exists. Outputs go to `config.work_dir`.
- **Logging/monitoring**: TensorBoard logs under `<work_dir>/<exp_name>/logs`; W&B runs can be disabled with `WANDB_MODE=offline`. TQDM progress shows loss and current `mask_beta`.
- **Gotchas**: `work_dir` is created at config load; keep paths writeable. Data loaders use `persistent_workers=4`; adjust if hitting CPU/thread limits. Bouncing Balls renderer uses OpenCV; ensure system packages allow headless use. Maze adapter exits if data missingâ€”run generator first.
